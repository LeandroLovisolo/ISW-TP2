\documentclass[a4paper, 10pt, twoside]{article}

\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[spanish, es-ucroman, es-noquoting]{babel}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{float}
\usepackage{enumitem} % Provee macro \setlist
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{hyperref}
\usepackage{multicol}
\usepackage{verbatim}
\usepackage{listings}
\usepackage[toc, page]{appendix}
\usepackage{color}


%%%%%%%%%% Configuración de Fancyhdr - Inicio %%%%%%%%%%
\pagestyle{fancy}
\thispagestyle{fancy}
\lhead{Trabajo Práctico 2 · Ingeniería de Software I}
\rhead{Delgado · Lovisolo · Petaccio · Requeni · Vita}
\renewcommand{\footrulewidth}{0.4pt}
\cfoot{\thepage /\pageref{LastPage}}

\fancypagestyle{caratula} {
   \fancyhf{}
   \cfoot{\thepage /\pageref{LastPage}}
   \renewcommand{\headrulewidth}{0pt}
   \renewcommand{\footrulewidth}{0pt}
}
%%%%%%%%%% Configuración de Fancyhdr - Fin %%%%%%%%%%


%%%%%%%%%% Miscelánea - Inicio %%%%%%%%%%
% Evita que el documento se estire verticalmente para ocupar el espacio vacío
% en cada página.
\raggedbottom

% Deshabilita sangría en la primer línea de un párrafo.
\setlength{\parindent}{0em}

% Separación entre párrafos.
\setlength{\parskip}{0.5em}

% Separación entre elementos de listas.
\setlist{itemsep=0.5em}

% Asigna la traducción de la palabra 'Appendices'.
\renewcommand{\appendixtocname}{Apéndices}
\renewcommand{\appendixpagename}{Apéndices}
%%%%%%%%%% Miscelánea - Fin %%%%%%%%%%


%%%%%%%%%% Insertar diagrama - Inicio %%%%%%%%%%
\newcommand{\diagramav}[1]{
  \includegraphics[type=png,ext=.png,read=.png,width=16cm]{diagramas/#1}
}

\newcommand{\diagramah}[1]{
  \includegraphics[type=png,ext=.png,read=.png,height=16cm,angle=90]{diagramas/#1}
}
%%%%%%%%%% Insertar diagrama - Fin %%%%%%%%%%


%%%%%%%%%% Macros para Casos de Uso - Inicio %%%%%%%%%%
\newcounter{usecasecounter}
\newcounter{usecasealtcounter}
\newcounter{nroCU}
\setcounter{nroCU}{0}

\newcommand{\ucname}[1]{\renewcommand{\givenucname}{#1}}
\newcommand{\ucpre}[1]{\renewcommand{\givenucpre}{#1}}
\newcommand{\ucpost}[1]{\renewcommand{\givenucpost}{#1}}
\newcommand{\ucactor}[1]{\renewcommand{\givenucactor}{#1}}
\newcommand{\givenucname}{REQUIRED!}
\newcommand{\givenucpre}{REQUIRED!}
\newcommand{\givenucpost}{REQUIRED!}
\newcommand{\givenucactor}{REQUIRED!}

\newenvironment{usecase}
  {}{
    \stepcounter{nroCU}
    \textbf{Caso de uso \arabic{nroCU}: }\givenucname \\
    \textbf{Pre: }\givenucpre \\
    \textbf{Post: }\givenucpost \\
    \textbf{Actores: }\givenucactor
  }

\newenvironment{usecasesteps}
  {
    \setcounter{usecasecounter}{0}
    \setcounter{usecasealtcounter}{0}

    \tabularx{\textwidth}{|l|X|}
    \hline
    Curso normal & Curso alternativo \\
    \hline
    \hline
  }{
    \endtabularx
    \vspace{\parskip}
  }

\newcommand{\ucstep}[2]{
  \stepcounter{usecasecounter}%
  \parbox[t]{7.5cm}{
    \makebox[2ex][l]{\arabic{usecasecounter}.}
    #1\phantom{p}
  }
  &
  \parbox[t]{7.5cm}{
    \setcounter{usecasealtcounter}{0}
    #2\phantom{p}
  } \\
  \hline
}

\newcommand{\ucalt}[1]{
  \stepcounter{usecasealtcounter}
  \makebox[4ex][l]{\arabic{usecasecounter}.\arabic{usecasealtcounter}.}
  #1
}
%%%%%%%%%% Macros para Casos de Uso - Fin %%%%%%%%%%


%%%%%%%%%% Macro para OCL - Inicio %%%%%%%%%%%%
\newenvironment{ocl}[1]
  {
    \textbf{#1}
    \verbatim
  }{
    \endverbatim
  }
%%%%%%%%%% Macro para OCL - Fin %%%%%%%%%%%%


\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Carátula                                                                  %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\thispagestyle{caratula}

\begin{center}

\includegraphics[height=2cm]{DC.png} 
\hfill
\includegraphics[height=2cm]{UBA.jpg} 

\vspace{2cm}

Departamento de Computación,\\
Facultad de Ciencias Exactas y Naturales,\\
Universidad de Buenos Aires

\vspace{4cm}

\begin{Huge}
Trabajo Práctico 2
\end{Huge}

\vspace{0.5cm}

\begin{Large}
Ingeniería de Software I
\end{Large}

\vspace{1cm}

Primer Cuatrimestre de 2014

\vspace{4cm}

\begin{tabular}{|c|c|c|}
\hline
Apellido y Nombre & LU & E-mail\\
\hline
Delgado, Alejandro N.  & 601/11 & nahueldelgado@gmail.com\\
Lovisolo, Leandro      & 645/11 & leandro@leandro.me\\
Petaccio, Lautaro José & 443/11 & lausuper@gmail.com\\
Requeni, Gastón        & 400/11 & grequeni@hotmail.com\\
Vita, Sebastián        & 149/11 & sebastian\_vita@yahoo.com.ar\\
\hline
\end{tabular}

\end{center}

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Índice                                                                    %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\tableofcontents

\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Introducción                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Introducción}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Desarrollo                                                                %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Desarrollo}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Casos de uso                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Casos de uso}

%%%%% Recibiendo mail de penalización %%%%%

\begin{usecase}
  \ucname{Recibiendo mail de penalización}
  \ucpre{True}
  \ucpost{El usuario conoce vía mail la penalización otorgada por el sistema}
  \ucactor{Usuario}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El sistema envía un mail al usuario informando las infracciones cometidas, indicando el motivo, el monto individual y total a pagar por las mismas.}{}
  \ucstep{El usuario recibe el mail enviado con la información de su penalización.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Registrando cuenta %%%%%

\begin{usecase}
  \ucname{Registrando cuenta}
  \ucpre{True}
  \ucpost{El usuario está registrado y autenticado en el sistema}
  \ucactor{Usuario}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El usuario ingresa su número de DNI, email, nombre y contraseña.}{}
  \ucstep{El sistema verifica que no esté registrado otro usuario con el email o DNI ingresado.}{}
  \ucstep{El sistema guarda los datos ingresados.}
         {\ucalt{Si los datos ingresados ya existían, mostrar que no es posible realizar el registro, y volver a 1.}}
  \ucstep{El sistema muestra al usuario que el registro se realizó correctamente.}{}
  \ucstep{El sistema autentica al usuario.}{}
  \ucstep{Si lo desea, el usuario puede clickear un enlace para consultar sus multas pendientes. Es extendido por {\bf CU 4}.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Autenticándose %%%%%

\begin{usecase}
  \ucname{Autenticándose}
  \ucpre{True}
  \ucpost{El usuario está autenticado en el sistema}  
  \ucactor{Usuario}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El usuario ingresa su número de DNI y su contraseña.}{}
  \ucstep{El sistema verifica que el usuario exista y que los datos ingresados sean correctos.}{}
  \ucstep{El sistema muestra al usuario que la autenticación fue satisfactoria.}
	       {\ucalt{Si los datos ingresados son incorrectos, el sistema indica que la autenticación no fue satisfactoria, y vuelve a 1.}}
  \ucstep{Si lo desea, el usuario puede clickear un enlace para consultar sus multas pendientes. Es extendido por {\bf CU 4}.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Consultando multas pendientes %%%%%

\begin{usecase}
  \ucname{Consultando multas pendientes}
  \ucpre{El usuario está autenticado}
  \ucpost{El usuario conoce las multas que tiene pendientes}
  \ucactor{Usuario}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El sistema muestra una tabla informando las infracciones cometidas, indicando el motivo, el monto individual y total a pagar por las mismas. Si no tiene infracciones, se muestra un mensaje informándolo.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Consultando disponibilidad de bicicletas %%%%%

\begin{usecase}
  \ucname{Consultando disponibilidad de bicicletas}
  \ucpre{True}
  \ucpost{El usuario conoce la disponibilidad de la estación deseada}
  \ucactor{Persona}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El sistema muestra una lista de las estaciones a consultar por disponibilidad.}{}
  \ucstep{La persona selecciona la estación deseada.}{}
  \ucstep{El sistema muestra la disponibilidad de la estación deseada.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Consultando monto a pagar de un DNI %%%%%

\begin{usecase}
  \ucname{Consultando monto a pagar de un DNI}
  \ucpre{True}
  \ucpost{El sistema muestra las multas pendientes por pagar de un determinado DNI}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de la estación ingresa el DNI del usuario a consultar las multas.}{}
  \ucstep{El sistema verifica que el DNI ingresado corresponda a un usuario.}{}
  \ucstep{Si existen multas por abonar, el sistema muestra que tipo de multas y el importe total. Si no existen multas, el sistema muestra que está libre de deudas.}
         {\ucalt{Si el DNI ingresado es incorrecto, mostrar mensaje de DNI equivocado y volver a 1.}}
  \ucstep{Si el personal de la estación desea registrar el pago de las multas, hace click en el botón “Pagar”. Es extendido por {\bf CU 7}.}{}
  \ucstep{Fin caso de uso}{}
\end{usecasesteps}

%%%%% Registrando pago de multa %%%%%

\begin{usecase}
  \ucname{Registrando pago de multa}
  \ucpre{La persona con el DNI provisto registraba una multa sin abonar}
  \ucpost{Se registra el cobro de la multa}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de la estación ingresa el DNI de un usuario que registra multas sin abonar.}{}
  \ucstep{El sistema registra el pago de la multa y despenaliza al usuario.}{}
  \ucstep{El sistema informa que la acción fue realizada exitosamente.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Registrando retiro de bicicleta %%%%%

\begin{usecase}
  \ucname{Registrando retiro de bicicleta}
  \ucpre{True}
  \ucpost{Se registra el retiro de bicicleta}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de estación ingresa el número de estación y presiona “Siguiente”. Si no lo ingresa, por default se toma el número de la estación en la que se encuentra.}{}
  \ucstep{El sistema registra la petición de una bicicleta.}
         {\ucalt{Si el número de estación no es válido, el sistema lo indica por pantalla. Fin CU.}}
  \ucstep{El sistema verifica el stock de la estación indicada.}{}
  \ucstep{El sistema reserva una bicicleta del stock hasta el fin del CU.}
         {\ucalt{Si no hay stock, muestra que no hay stock. Fin CU.}}
  \ucstep{El personal de la estación ingresa el DNI.}{}
  \ucstep{El sistema verifica que el usuario esté registrado.}{}
  \ucstep{El sistema verifica que el usuario no esté penalizado.}
         {\ucalt{Si el usuario no está registrado, muestra que no existe en el sistema. Fin CU.}}
  \ucstep{El personal de la estación ingresa el número de la bicicleta a asignar al usuario.}
         {\ucalt{Si el usuario está penalizado, se informa que lo está. Fin CU.}}
  \ucstep{El sistema verifica que el ID de la bicicleta ingresada pertenezca a una bicicleta en la estación.}{}
  \ucstep{El sistema registra la entrega de la bicicleta guardando ID de estación, DNI, ID de bicicleta, fecha y hora actual.}
         {\ucalt{Si el ID ingresado es erróneo, muestra que es incorrecto y vuelve a 7.}}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Registrando devolución de bicicleta %%%%%

\begin{usecase}
  \ucname{Registrando devolución de bicicleta}
  \ucpre{El usuario había retirado una bicicleta}
  \ucpost{Se registra la devolución de la bicicleta entregada}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de estación ingresa el número de estación y presiona “Siguiente”. Si no lo ingresa, por default se toma el número de la estación en la que se encuentra.}{}
  \ucstep{El personal de la estación puede ingresar o no el número de DNI del usuario que devuelve la bicicleta. Si no lo ingresa, el sistema muestra una advertencia de posible penalización al usuario que retiró la bicicleta.}
         {\ucalt{Si el número de estación no es válido, el sistema lo indica por pantalla. Fin CU.}}
  \ucstep{El personal de la estación ingresa el ID de la bicicleta devuelta y el estado de la misma (“Buen Estado” o “Mal Estado”).}{}
  \ucstep{El sistema valida que el usuario que entregó la bicicleta sea el mismo que la retiró, que no haya usado la bicicleta más de una hora y que la bicicleta devuelta no esté en mal estado.}{}
  \ucstep{Si falla alguna de las validaciones del paso 4, se penaliza al usuario y se informa por pantalla el motivo. Ver {\bf DA “Penalizaciones”}.}{}
  \ucstep{El sistema registra la devolución de la bicicleta, aumenta el stock y muestra que la devolución se realizó correctamente.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Registrando datos de bicicletas retiradas por la empresa de transporte %%%%%

\begin{usecase}
  \ucname{Registrando datos de bicicletas retiradas por la empresa de transporte}
  \ucpre{El sistema dió la orden de mover bicicletas y descontó el stock de las mismas de la estación (y marcó esa cantidad como “reservada”)}
  \ucpost{El personal de la estación registra las bicicletas que se retirarán}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de estación ingresa el número de estación y presiona “Siguiente”. Si no lo ingresa, por default se toma el número de la estación en la que se encuentra.}{}
  \ucstep{El personal de la estación ingresa el ID relacionado al envío.}
	       {\ucalt{Si el número de estación no es válido, el sistema lo indica por pantalla. Fin CU.}}
  \ucstep{El sistema verifica que el ID ingresado del envío sea un envío que salga de la estación donde se ingresó y que no haya sido completado anteriormente.}{}
  \ucstep{El sistema muestra la cantidad de bicicletas que se necesitan trasladar y los campos para ingresar los ID’s de las mismas.}
	       {\ucalt{Si el ID de envío ingresado es incorrecto, volver a 3) y mostrar mensaje.}}
  \ucstep{El personal de la estación ingresa los ID de las bicicletas a entregar a la empresa de transporte.}{}
  \ucstep{El sistema verifica que los IDs de las bicicletas ingresadas pertenezcan a bicicletas en la estación.}{}
  \ucstep{El sistema registra el retiro de las bicicletas con los ID ingresados.}
	       {\ucalt{SSi alguno de los IDs ingresados es erróneo, muestra que es incorrecto y vuelve a 2).}}
  \ucstep{El sistema muestra que la operación fue realizada exitosamente.}{}
  \ucstep{Fin caso de uso.}{}
  
\end{usecasesteps}

%%%%% Registrando datos de bicicletas recibidas de la empresa de transporte %%%%%

\begin{usecase}
  \ucname{Registrando datos de bicicletas recibidas de la empresa de transporte}
  \ucpre{Llega un camión con bicicletas y las descarga en la estación}
  \ucpost{Se registra en el sistema la llegada de las bicicletas}
  \ucactor{Personal de la estación}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal de estación ingresa el número de estación y presiona “Siguiente”. Si no lo ingresa, por default se toma el número de la estación en la que se encuentra.}{}
  \ucstep{El personal de la estación ingresa el ID relacionado al envío.}{}
  \ucstep{El sistema verifica que el ID ingresado del envío sea un envío que tuviera como destino el ID de la estación ingresada y no se haya completado anteriormente.}{}
  \ucstep{El sistema muestra la cantidad de bicicletas que deberían llegar y los campos para ingresar los ID’s de las mismas.}
         {\ucalt{Si el ID de envío ingresado es incorrecto, volver a 3) y mostrar mensaje.}}       
  \ucstep{El personal de la estación ingresa los ID de las bicicletas recibidas.}
         {\ucalt{Si el número de estación no es válido, el sistema lo indica por pantalla. Fin CU.}}
  \ucstep{El sistema verifica que los ID de las bicicletas ingresadas estuvieran siendo transportadas hacia esta estación.}{}
  \ucstep{El sistema registra la ubicación de las bicicletas con los ID ingresados y actualiza el stock de la estación.}
         {\ucalt{Si existe algún ID que no concuerda con el transporte realizado, se muestra por pantalla cuál ID está erróneo y el personal de la estación puede optar por volver a 1) y re ingresar correctamente el ID o en el caso que los IDs ingresados sean correctos, clickear “Omitir” y el sistema se encargará de corregir el error usando los datos de registro.}}
  \ucstep{El sistema muestra que la operación fue realizada exitosamente.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

{\underline{Aclaración de 7.1:}} Veamos cómo el sistema realiza la corrección con un ejemplo:
Tenemos la estación A y la estación B. Llega un camión a la estación A con la orden de transportar 5 bicicletas desde allí hasta la estación B. El personal de la estación en A ingresa los 5 IDs (que corresponden a bicicletas en la estación A) y el sistema las valida. Luego le entrega al camión 5 bicicletas, de las cuales 3 son erróneas (no se corresponden con ninguno de los IDs ingresados). Luego el camión viaja y las entrega en la estación B.
El personal de la estación B ingresa los 5 IDs de las bicicletas que le llegaron y el sistema rechaza 3 de ellas porque no coinciden con el registro de envío. Entonces el personal clickea “Omitir” y el sistema intercambia las ubicaciones de las 3 bicicletas que llegaron con las 3 que estaban registradas en el envío. Observar que las 3 que viajaron y que según el sistema estaban en la estación A, no podrán ser retiradas hasta que no se haga la corrección (ver paso 9 de {\bf CU 8}).

%%%%% Autenticándose como administrador %%%%%

\begin{usecase}
  \ucname{Autenticándose como administrador}
  \ucpre{True}
  \ucpost{El personal del gobierno está autenticado como administrador}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal del gobierno ingresa su usuario y su contraseña.}{}
  \ucstep{El sistema verifica que el usuario exista y que los datos ingresados sean correctos.}{}
  \ucstep{El sistema muestra al usuario que la autenticación fue satisfactoria.}
         {\ucalt{Si los datos ingresados son incorrectos, el sistema indica que la autenticación no fue satisfactoria, y vuelve a 1.}}
  \ucstep{Si lo desea, el personal del gobierno puede hacer click en alguno de los siguientes enlaces:
          \begin{itemize}[itemsep=-3pt, topsep=1pt]
            \item Registrar nuevas bicicletas. Es extendido por {\bf CU 13}.
            \item Registrar una nueva estación. Es extendido por {\bf CU 14}.
            \item Informar la eliminación de una bicicleta. Es extendido por {\bf CU 15}.
            \item Estadísticas del sistema. Es extendido por {\bf CU 16}.
            \item Invalidar penalizaciones de un usuario. Es extendido por {\bf CU 17}.
          \end{itemize}
         }{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Registrando nuevas bicicletas %%%%%

\begin{usecase}
  \ucname{Registrando nuevas bicicletas}
  \ucpre{El personal del estado está autenticado}
  \ucpost{Nuevas bicicletas registradas en el sistema y el personal del gobierno conoce los IDs asignados a las bicicletas.}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal del gobierno de mar chiquita ingresa la cantidad de bicicletas nuevas y el ID de la estación inicial.}{}
  \ucstep{El sistema registra el número de bicicletas ingresado por el personal, asignándole a cada bicicleta registrada un ID único.}{}
  \ucstep{El sistema informa al personal los IDs de las bicicletas registradas.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%%% Registrando nueva estación %%%%%

\begin{usecase}
  \ucname{Registrando nueva estación}
  \ucpre{El personal del gobierno está autenticado}
  \ucpost{Se registra en el sistema la nueva estación}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal del gobierno ingresa el nombre de la nueva estación y su dirección, indicando si pertenece al centro o a la periferia.}{}
  \ucstep{El sistema verifica si ya existe una estación con el mismo nombre o la misma dirección.}{}
  \ucstep{El sistema muestra que el ingreso de la nueva estación fue correcto.}
         {\ucalt{Si existe una estación con el mismo nombre o la misma dirección, mostrar cuál fue el ingreso erróneo y volver a 1.}}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Informando bicicleta a eliminar %%%%%

\begin{usecase}
  \ucname{Informando bicicleta a eliminar}
  \ucpre{El personal del gobierno está autenticado}
  \ucpost{Una bicicleta es eliminada del sistema}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal del gobierno ingresa el ID de la bicicleta a eliminar del sistema.}{}
  \ucstep{El sistema verifica que el ID de la bicicleta a eliminar corresponda a una bicicleta en el sistema.}{}
  \ucstep{El sistema elimina la bicicleta con ID ingresado.}
         {\ucalt{Si el ID es incorrecto, mostrar que el ID ingresado no es válido y volver a 1.}}
  \ucstep{El sistema muestra que la operación se realizó correctamente e informa la última ubicación de la bicicleta.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Consultando estadísticas %%%%%

\begin{usecase}
  \ucname{Consultando estadísticas}
  \ucpre{El personal del gobierno está autenticado}
  \ucpost{El personal del gobierno conoce estadísticas del sistema}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El sistema muestra en pantalla una tabla con la siguiente información:
          \begin{itemize}[itemsep=-3pt, topsep=1pt]
            \item{
              Información general actualizada:
              \begin{itemize}[itemsep=-3pt, topsep=0pt]
                \item Cantidad de usuario registrados.
                \item Cantidad de usuarios en infracción.
              \end{itemize}
            }
            \item{
              Información por semana (de las últimas 4 semanas completadas):
              \begin{itemize}[itemsep=-3pt, topsep=-2pt]
                \item Promedio de bicicletas retiradas por hora en estaciones céntricas.
                \item Promedio de bicicletas retiradas por hora en estaciones periféricas.
                \item Promedio de bicicletas solicitadas (retiradas y no retiradas) por hora en estaciones céntricas.
                \item Promedio de bicicletas solicitadas por hora en estaciones periféricas.
                \item Las 5 estaciones con más solicitudes en total.
                \item Las 5 estaciones con menos solicitudes en total.
              \end{itemize}
            }
          \end{itemize}
         }{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Invalidando penalización %%%%%

\begin{usecase}
  \ucname{Invalidando penalización}
  \ucpre{El personal del gobierno está autenticado}
  \ucpost{El personal del gobierno despenaliza a un usuario.}
  \ucactor{Personal del gobierno}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El personal del gobierno indica el DNI del usuario que desea despenalizar.}{}
  \ucstep{El sistema verifica que el DNI esté registrado y tenga alguna penalización.}{}
  \ucstep{El sistema muestra una tabla informando las infracciones cometidas por el usuario, indicando el motivo, el monto individual y total a pagar por las mismas.}
         {\ucalt{Si el DNI no estaba registrado, el sistema muestra por pantalla que el DNI es erróneo y regresa a 1. Si el DNI estaba registrado pero no tenía ninguna penalización, muestra un mensaje informándolo y vuelve a 1.}}
  \ucstep{El personal del gobierno selecciona las penalizaciones que desea eliminar de la tabla y hace clic en “Eliminar”.}{}
  \ucstep{El sistema elimina todo registro de las penalizaciones seleccionadas por el personal del gobierno.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}

%%%%% Recibiendo mail de instrucciones para movilización de bicicletas %%%%%

\begin{usecase}
  \ucname{Recibiendo mail de instrucciones para movilización de bicicletas}
  \ucpre{True}
  \ucpost{El personal de la empresa de transporte recibe el mail con las indicaciones de cómo mover las bicicletas}
  \ucactor{Personal de la empresa de transporte}
\end{usecase}
\begin{usecasesteps}
  \ucstep{El sistema envía mail al personal de la empresa de transporte informando cómo mover las bicicletas. En una tabla, por cada entrada indica: ID del envío, estación orígen, estación destino, la dirección de cada estación y la cantidad de bicicletas a trasladar.}{}
  \ucstep{El personal de la empresa de transporte recibe el mail.}{}
  \ucstep{Fin caso de uso.}{}
\end{usecasesteps}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Modelo conceptual                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Modelo conceptual}


\subsection{Modelo}

Pendiente.


\subsection{OCL}


\subsubsection{Penalizaciones}

\begin{ocl}{Ningún campo de las penalizaciones es null}
  context Penalización
  inv: self.fechaDeCreación <> null and
       self.tipoDePenalización <> null and
       self.multa <> null and
       (self.pago <> null implies self.pago.fechaPago <> null)
\end{ocl}

\begin{ocl}{Si hay una penalización en mal estado, existe una devolución en mal estado}
  context Penalización
  inv: self.tipo = DevoluciónEnMalEstado implies self.usuario.devoluciones->exists(d |
           d.enBuenEstado = false and d.fechaYHora = self.fechaCreación)
\end{ocl}

\begin{ocl}{Si hay una multa por devolución por otra persona, existe una devolución sin usuario o con un usuario distinto}
  context Penalización
  inv: self.tipo = BiciDevueltaPorOtraPersona implies
           self.usuario.retiros->select(r | r.devolución <> null)
                               ->exists(r | (r.devolución.usuario = null or
                                             r.devolución.usuario != r.usuario) and
                                            r.devolución.fechaYHora = self.fechaCreación)
\end{ocl}

\begin{ocl}{Si hay una multa por pasar más de una hora, existe un retiro sin devolución por más de una hora}
  context Penalización
  inv: self.tipo = PasoUnaHoraDesdeRetiro implies self.usuario.retiros->exists(r |
           (r.devolución = null or (r.devolución <> null and
                                    r.devolución.fechaYHora >= r.fechaYHora + 1h)) and
           self.fechaCreación = r.fechaYHora + 1h)
\end{ocl}

\begin{ocl}{Para cada devolución en mal estado existe una penalización}
  context DevoluciónDeBicicleta
  inv: self.enBuenEstado = false implies
           self.retiro.usuario.penalizaciones->exists(p |
               p.fechaCreación = self.fechaYHora and
               p.tipo = DevoluciónEnMalEstado)
\end{ocl}

\begin{ocl}{Si existe una devolución sin usuario, hay multa por devolución de otro usuario}
  context DevoluciónDeBicicleta
  inv: self.usuario = null implies
           self.retiro.usuario.penalizaciones->exists(p |
               p.tipo = BiciDevueltaPorOtraPersona and
               p.fechaCreación = self.fechaYHora)
\end{ocl}

\begin{ocl}{Si existe una devolución con otro usuario, hay multa para el usuario que la retiró}
  context DevoluciónDeBicicleta
  inv: (self.usuario <> self.retiro.usuario and self.usuario <> null) implies
           self.retiro.usuario.penalizaciones->exists(p |
               p.tipo = BiciDevueltaPorOtraPersona)
\end{ocl}

\begin{ocl}{Si existe un retiro de bicicleta donde ya pasó más de una hora, hay una multa (automática)}
  context RetiroDeBicicleta
  inv: (self.devolución = null and today() >= self.fechaYHora + 1h) implies
           self.usuario.penalizaciones->exists(p |
               (p.fechaCreación = self.fechaYHora + 1h) and
               p.tipo = PasoUnaHoraDesdeRetiro)
\end{ocl}

\begin{ocl}{Los pagos ocurren en una fecha después de la penalización}
  context Penalización
  inv: self.pago <> null implies self.fechaCreación <= self.pago.fechaPago
\end{ocl}


\subsubsection{Retiros}

\begin{ocl}{Todo retiro tiene una solicitud con la misma hora}
  context RetiroDeBicicleta
  inv: self.solicitud.fechaYHora = self.fechaYHora
\end{ocl}

\begin{ocl}{No puede existir un retiro de bicicletas si existía alguna penalización sin pagar antes del retiro}
  context RetiroDeBicicleta
  inv: self.usuario.penalizaciones->forAll(p |
           (p.fechaCreación < self.fechaYHora) implies
               (p.pago <> null and
               p.pago.fechaPago <= self.fechaYHora))
\end{ocl}

\begin{ocl}{Un usuario no puede tener más de una bicicleta}
  context Usuario
  inv: self.retiros->select(r1 | r1.devolución = null)->size() <= 1
\end{ocl}

\begin{ocl}{No hay solapamientos entre los retiros (franjas de entrega y devolución que se solapen)}
  context RetiroDeBicicleta
  inv: RetiroDeBicicleta->allInstances()->forAll(r1, r2 |
           (r1 <> r2 and r1.devolución <> null and r2.devolución <> null) implies
               ((r1.fechaYHora < r2.fechaYHora implies
                   r1.devolución.fechaYHora < r2.fechaYHora) and
                (r1.fechaYHora > r2.fechaYHora implies
                   r1.devolución.fechaYHora > r2.fechaYHora)))
\end{ocl}

\begin{ocl}{Los retiros tienen fecha mayor o igual a la de las devoluciones}
  context RetiroDeBicicleta
  inv: self.devolucion <> null implies self.fechaYHora >= self.devolución.fechaYHora
\end{ocl}


\subsubsection{Bicicletas}

\begin{ocl}{Los IDs de las bicicletas no son nulos}
  context Bicicleta
  inv: self.id <> null
\end{ocl}

\begin{ocl}{No hay otra bicicleta con el mismo ID}
  context Bicicleta
  inv: Bicicleta.allInstances()->forAll(b1, b2 | b1 <> b2 implies b1.id <> b2.id)
\end{ocl}

\begin{ocl}{Una bicicleta no puede estar en más de dos envíos (sin fecha de llegada)}
  context Bicicleta
  inv: self.transportes->select(t | t.fechaYHoraLlegada = null)->size() <= 1
\end{ocl}

\begin{ocl}{Una bicicleta está en una estación, en transporte o en posesión de un usuario}
  context Bicicleta
  int EstáEnEstacion: self.estación <> null and
                      not self.transportes.exists(t |
                          t.fechaYHoraLllegada = null and
                          self.retiros->size() = self.devoluciones->size())
  int EstáEnTransporte: self.estación = null and
                        self.transportes.exists(t | t.fechaYHoraLllegada = null) and
                        self.retiros->size() = self.devoluciones->size()
  int EstáEnPosesiónDeUnUsuario: self.estación = null and
                                 not self.transportes.exists(t |
                                     t.fechaYHoraLllegada = null) and
                                 self.retiros->size() = self.devoluciones->size() + 1
\end{ocl}


\subsubsection{Orden de transporte}

\begin{ocl}{Los IDs de las ordenes de transporte nunca son null}
  context OrdenDeTransporte
  inv: self.id <> null
\end{ocl}

\begin{ocl}{Toda orden de transporte tiene un ID distinto de los otros}
  context OrdenDeTransporte
  inv: OrdenDeTransporte.allInstances()->forAll(o1, o2 |
           o1 <> o2 implies o1.id <> o2.id)
\end{ocl}

\begin{ocl}{Una orden de transporte no puede tener el mismo origen que destino}
  context OrdenDeTransporte
  inv: self.orígen <> self.destino
\end{ocl}


\subsubsection{Envíos}

\begin{ocl}{Los envíos tienen fecha de llegada mayor a la fecha de salida en el caso de que hayan llegado o null si no llegaron a destino}
  context Envío
  inv: self.fechaYHoraLLegada = null or self.fechaYHoraSalida < self.fechaYHoraLlegada
\end{ocl}

\begin{ocl}{Los envíos siempre existen con fecha de inicio}
  context Envío
  inv: self.fechaYHoraSalida <> null
\end{ocl}

\begin{ocl}{No hay solapamientos en envíos por cada bicicleta}
  context Bicicleta
  inv: self.transportes->forAll(e1, e2 |
           (e1 <> e2 and e1.fechaYHoraLlegada <> null and e2.fechaYHoraLlegada <> null) implies
               ((e1.fechaYHoraSalida  < e2.fechaYHoraSalida implies
                 e1.fechaYHoraLlegada < e2.fechaYHoraSalida) and
                (e1.fechaYHoraSalida  > e2.fechaYHoraSalida implies
                 e1.fechaYHoraLlegada > e2.fechaYHoraSalida)))
\end{ocl}

\begin{ocl}{Debe de haber la cantidad especificada de bicicletas por la orden en el envío}
  context Envío
  inv: self.orden.cantBicis = self.bicicletas->size()
\end{ocl}


\subsubsection{Usuarios}

\begin{ocl}{Ningún campo de usuarios puede ser Null}
  context Usuario
  inv: self.dni <> null and
       self.nombre <> null and
       self.email <> null and
       self.email <> null and
       self.clave <> null
\end{ocl}

\begin{ocl}{No existen usuarios con el mismos DNI y mail}
  context Usuario
  inv: Usuario.allInstances()->forAll(u1, u2 |
           u1 <> u2 implies (u1.dni <> u2.dni and u1.email <> u2.email))
\end{ocl}


\subsubsection{Estaciones}

\begin{ocl}{Las bicicletas reservadas concuerdan con la cantidad de bicicletas reservadas para envíos en las órdenes de transporte}
  context Estación
  inv: self.órdenesRetiro->select(e | e.envío = null)
                         ->collect(e.cantBicis)
                         ->sum() = self.cantBicisReservadas
\end{ocl}

\begin{ocl}{El stock más la cantidad de bicis reservadas es igual a la cantidad de bicicletas en la estación}
  context Estación
  inv: self.stock + self.cantBicisReservadas = self.bicicletas->size()
\end{ocl}

\begin{ocl}{Las estaciones no tienen el mismo nombre o dirección}
  context Estación
  inv: Estación.allInstances()->forAll(e1, e2 |
           (e1 <> e2) implies (e1.nombre <> e2.nombre and e1.dirección <> e2.dirección))
\end{ocl}

\begin{ocl}{Demanda promedio en hora pico y hora no-pico}
  context Estación
  inv: self.estadísticas.promedioHoraPico = 
       self.personal.solicitudes
           ->select(fechaYHora->dia >= today()->dia - 7 and
                    fechaYHora->hora >= 17 and
                    fechaYHora->hora <= 20)
           ->size() / 7
  inv: self.estadísticas.promedioHoraNoPico = 
       self.personal.solicitudes
           ->select(fechaYHora->dia >= today()->dia - 7 and
                    fechaYHora->hora < 17 or
                    fechaYHora->hora > 20)
           ->size() / 7
\end{ocl}

\begin{ocl}{Distribución}
  context Estación
  inv: self.distribución.horaNoPico =
           Bicicleta.allInstances()->size() /
           Estación.allInstances()->size()
  inv: self.distribución.horaPico =
           (if self.oclIsTypeOf(EstaciónPeriférica) then
               self.estadísticas.promedioHoraPico * 0.25
           else
               self.estadísticas.promedioHoraPico
           endif) /
           Estación.allInstances()
               ->collect(if oclIsTypeOf(EstaciónPeriférica) then
                             estadísticas.promedioHoraPico * 0.25
                         else
                             estadísticas.promedioHoraPico
                         endif)
               ->sum() *
           Bicicleta.allInstances()->size()
\end{ocl}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Diagramas de actividad                                                    %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Diagramas de actividad}

\subsection{Penalizaciones}

Este diagrama describe la asignación de penalizaciones ante la devolución de una bicicleta. Las reglas de penalización son las siguientes:
\begin{itemize}
 \item Si la bicicleta es devuelta por una persona que no la retiró (sea usuario o no), el usuario que la retiró es penalizado con
 ``BiciDevueltaPorOtraPersona''.
 \item Si la bicicleta es devuelta por el usuario que la retiró y está en mal estado, el usuario (que la retiró y también devolvió) es penalizado
 con ``DevoluciónEnMalEstado''.
\end{itemize}
Observar que asumimos que siempre que una bicicleta es devuelta, había sido retirada por alguien (el ``usuario que la retiró'' siempre existe).
Esto se debe a que no tenemos en cuenta en nuestro modelo la baja de usuarios ni tampoco el robo de bicicletas directamente de la estación (sin que hayan sido entregadas a un usuario).

Cabe aclarar que estas no son todas las penalizaciones posibles, sino que son únicamente las que se desencadenan ante la devolución de una bicicleta.
Ver {\bf FSM ``Penalizaciones''} (Sección \ref{fsm:penalizaciones}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Máquinas de estado                                                        %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Máquinas de Estado}

\subsection{Penalizaciones} \label{fsm:penalizaciones}


\end{document}